<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Mapa - {{ profile }}</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <!-- A√±adir Turf.js -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="info-panel">
        <h1>Workshop Movilidad</h1>
        <p><strong>{{ profile }}</strong></p>
        <h2>UUID del Usuario: <strong>{{ uuid }}</strong></h2>
        <div class="controls">
            <button id="toggleArea" class="btn">Ocultar √Årea</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- üöÄ BOT√ìN FLOTANTE -->
    <button id="survey-fab" class="floating-action-button" title="Abrir Encuesta">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
    </button>

    <!-- üöÄ MODAL DE ENCUESTA (inicialmente oculto) -->
    <div id="survey-modal" class="survey-modal">
        <div class="survey-modal-content">
            <div class="survey-modal-header">
                <h2>üìã Encuesta de Movilidad</h2>
                <button id="close-survey" class="close-button">&times;</button>
            </div>
            <div class="survey-modal-body">
                <div id="survey123" class="survey-container"></div>
            </div>
        </div>
    </div>

    <!-- üöÄ OVERLAY DE FONDO -->
    <div id="survey-overlay" class="survey-overlay"></div>

    <script>
        window.mapConfig = {
            apiKey: '{{ mapbox_api_key }}',
            profile: '{{ profile }}',
            relPath: '{{ rel_path }}',
            center: [-73.0586, -36.8274],
            zoom: 13
        };
    </script>

    <script src="/static/js/script.js"></script>

    <!-- üöÄ NUEVO: librer√≠a Survey123 -->
    <script src="https://survey123.arcgis.com/api/jsapi"></script>

    <!-- üöÄ NUEVO: l√≥gica del modal y encuesta -->
    <script>
        const SURVEY_ITEM_ID = "50c150f7931e43c389b5bb2ceac75cbc";

        // Referencias a elementos del DOM
        const surveyFab = document.getElementById('survey-fab');
        const surveyModal = document.getElementById('survey-modal');
        const surveyOverlay = document.getElementById('survey-overlay');
        const closeSurvey = document.getElementById('close-survey');

        let survey = null;
        let surveyInitialized = false;

        // Funci√≥n para abrir el modal
        function openSurveyModal() {
            surveyModal.classList.add('active');
            surveyOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevenir scroll

            // Inicializar encuesta solo la primera vez
            if (!surveyInitialized) {
                initializeSurvey();
            }
        }

        // Funci√≥n para cerrar el modal
        function closeSurveyModal() {
            surveyModal.classList.remove('active');
            surveyOverlay.classList.remove('active');
            document.body.style.overflow = 'auto'; // Restaurar scroll
        }

        // Inicializar Survey123
        function initializeSurvey() {
            try {
                survey = new Survey123WebForm({
                    container: "survey123",
                    itemId: SURVEY_ITEM_ID,
                    // Par√°metros adicionales si los necesitas
                    // portalUrl: "https://www.arcgis.com"
                });

                survey.on("ready", () => {
                    console.log("‚úÖ Encuesta lista");
                    surveyInitialized = true;
                });

                survey.on("submit", (response) => {
                    console.log("üì® Respuesta enviada:", response);
                    
                    // Mostrar mensaje de √©xito
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message';
                    successMsg.innerHTML = `
                        <div class="success-content">
                            <h3>¬°Gracias! üéâ</h3>
                            <p>Tu respuesta se ha enviado correctamente</p>
                        </div>
                    `;
                    document.body.appendChild(successMsg);

                    // Cerrar modal despu√©s de 2 segundos
                    setTimeout(() => {
                        closeSurveyModal();
                        successMsg.remove();
                    }, 2000);
                });

                survey.on("survey123-error", (err) => {
                    console.error("‚ö†Ô∏è Error Survey123:", err);
                    alert("Hubo un problema cargando la encuesta. Por favor, intenta nuevamente.");
                });

            } catch (error) {
                console.error("‚ùå Error inicializando Survey123:", error);
                alert("No se pudo cargar la encuesta. Verifica la conexi√≥n a internet.");
            }
        }

        // Event listeners
        surveyFab.addEventListener('click', openSurveyModal);
        closeSurvey.addEventListener('click', closeSurveyModal);
        surveyOverlay.addEventListener('click', closeSurveyModal);

        // Cerrar con tecla Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && surveyModal.classList.contains('active')) {
                closeSurveyModal();
            }
        });
    </script>
</body>
</html>
